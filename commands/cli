#!/bin/bash
SERVICE_NAME="$1"

echo "-----> Connecting to Redis CLI for $SERVICE_NAME"

# Source helper functions
source /opt/gokku/scripts/plugin-helpers.sh

# Check if container exists
if ! container_exists "$SERVICE_NAME"; then
    echo "Service '$SERVICE_NAME' not found"
    exit 1
fi

# Check if container is running
if ! container_is_running "$SERVICE_NAME"; then
    echo "Service '$SERVICE_NAME' is not running"
    exit 1
fi

# Get Redis password
# REDIS_PASSWORD=$(get_service_config "$SERVICE_NAME" | grep -o '"password":"[^"]*"' | cut -d'"' -f4)
REDIS_PASSWORD=$(get_service_config "$SERVICE_NAME" | jq -r '.password')

# Connect to Redis CLI
echo "Connecting to Redis CLI..."
echo "Type 'exit' to quit"
echo ""

# Check if we have a command to execute
if [ "$2" = "-c" ] && [ -n "$3" ]; then
    # Execute single command
    echo "Executing Redis command: $3"
    echo "$3" | docker exec -i "$SERVICE_NAME" redis-cli -a "$REDIS_PASSWORD"
else
    # Interactive mode - check if we have a TTY
    if [ -t 0 ] && [ -t 1 ]; then
        # We have a TTY, use interactive mode
        echo "Connecting to Redis CLI..."
        echo "Type 'exit' to quit"
        echo ""
        docker exec -it "$SERVICE_NAME" redis-cli -a "$REDIS_PASSWORD"
    else
        # No TTY available, use non-interactive mode
        echo "Connecting to Redis CLI (non-interactive mode)..."
        echo "Type 'exit' to quit"
        echo ""
        docker exec "$SERVICE_NAME" redis-cli -a "$REDIS_PASSWORD"
    fi
fi
